<pre>
  BIP: ?
  Layer: Consensus (soft fork)
  Title: CISA for Taproot Keypath Spends
  Author: Fabian Jahr <fjahr@protonmail.com>
  Comments-Summary: No comments yet.
  Comments-URI: https://github.com/bitcoin/bips/wiki/Comments:BIP-?
  Status: Draft
  Type: Standards Track
  Created: 2025-09-15
  License: BSD-3-Clause
  Post-History: TODO
  Requires: 340, 341, 342, BIP-Halfagg, BIP-Fullagg
</pre>

== Abstract ==

This document proposes the introduction of cross-input signature aggregation
(CISA) for Bitcoin transactions. A new witness version (v2) is introduced that
enables Taproot-style keypath spending with support for two Schnorr signature
aggregation schemes: half-aggregation and full-aggregation. Half-aggregation
non-interactively reduces n signatures from 64*n bytes to (n+1)*32 bytes, while
full-aggregation reduces the n signatures to a constant 64 bytes (but requiring
interactivity at signing time). Inputs use a 1-byte or 2-byte marker in their
witness to indicate their aggregation mode (half-agg, full-agg, or opt-out) and
optionally specify a sighash type. An opt-out marker protects inputs that must
not be aggregated, such as those using adaptor signatures.

== Copyright ==

This document is licensed under the 3-clause BSD license.

== Motivation ==

Bitcoin transaction sizes are heavily influenced by signature data. Each Taproot
keypath spend requires a 64-byte BIP340 Schnorr signature. For transactions with
multiple inputs, this signature overhead is substantial and represents a
scalability limitation and cost liability to the users.

However, the linear properties of Schnorr signatures enable signature
aggregation, where multiple signatures can be cryptographically combined into a
more compact form. Cross-input signature aggregation addresses this inefficiency
by allowing multiple signatures within a single transaction to be aggregated.

This provides:

* '''Significant space savings''': Transaction size reductions depending on the number of inputs and aggregation scheme used
* '''Lower fees''': Users pay less for multi-input transactions due to the space savings
* '''Economic incentive for privacy''': CoinJoin/PayJoin transactions become cheaper than equivalent standard transactions, inverting the traditional cost-privacy tradeoff
* '''Improved scalability''': More transactions per block without increasing the block weight limit
* '''Flexible usage''': Two aggregation schemes (half-agg and full-agg) serve different use cases with the possibility to opt out specific inputs
* '''Protocol compatibility''': Explicit opt-out mechanism protects protocols such as adaptor signatures that are incompatible with aggregation

For detailed numbers on space and fee savings, please refer to the respective
signature scheme BIPs (Halfagg or Fullagg).

=== Use Cases ===

* '''CoinJoin/PayJoin Transactions''': Currently, CoinJoin and PayJoin transactions are hard to user for average Bitcoin users due to lack of support in mainstream wallets with friendly UX, creating a disincentive for privacy. With CISA, CoinJoin and PayJoin transactions become cheaper per-input as the number of participants increases, economically incentivizing privacy-enhancing usage and mainstream adoption.
* '''Consolidation and Batching''': Businesses and users combining many small UTXOs into a single output or multiple payment outputs benefit from dramatically reduced transaction costs.
* '''Lightning Network''': Channel announcements containing four signatures that can be aggregated, reducing the space needed for signatures in gossip bandwidth by up to 75%.

Aside from these highlighted use cases, even average on-chain transactions
from any user should profit from adopting CISA through fee savings.

== Design ==

This BIP introduces a new witness version (v2) that enables signature
aggregation for Taproot-style keypath spends. The design aims to follow these
principles:

* '''Minimize changes''': Reuse existing Taproot and tapscript code. Maintain compatibility with BIP340, BIP341, and BIP342 wherever possible.
* '''Gradual upgrade possibilities''': Users can adopt witness v2 outputs independently of whether they use aggregation. Aggregation is opt-in on a per-input basis.
* '''Support multiple aggregation schemes''': Half-aggregation (non-interactive) and full-aggregation (interactive) serve different use cases and should both be supported.
* '''Explicit opt-out''': Inputs that must not be aggregated (e.g., for adaptor signature compatibility) can use an explicit opt-out marker to protect against non-consensual aggregation by third parties.
* '''Keypath only''': Limit aggregation to keypath spends to reduce complexity. Script path aggregation is deferred to future proposals.

The main design decision is to use a marker-based approach where all inputs
contain a 1-byte or 2-byte marker (aggregation type + optional sighash type).
For aggregated inputs, the last input in each aggregation group includes the
aggregate signature concatenated with the marker. This design:

* Minimizes witness data for aggregated inputs
* Provides clear indication of which inputs participate in aggregation
* Allows each input to independently specify its sighash type if needed
* Allows mixing aggregated and non-aggregated inputs in the same transaction
* Protects opted-out inputs from non-consensual aggregation by third parties (even potential block-wide aggregation)
* Enables validators to identify the aggregation scheme by signature size
* Supports up to two aggregation groups per transaction (one half-agg, one full-agg)

== Specification ==

=== Witness Version 2 ===

A new witness version is introduced to enable signature aggregation. Witness
version 2 outputs are created with:

* '''ScriptPubKey''': <code>OP_2 <32-byte x-only pubkey></code> (or <code>0x5220{32-byte x-only pubkey}</code>)
* '''Address Format''': Bech32m encoding with prefix <code>bc1</code> (mainnet) or <code>tb1</code> (testnet). This means the addresses will start with <code>bc1z</code> and <code>tb1z</code> respectively.

The 32-byte x-only pubkey is computed identically to BIP341 Taproot outputs.

=== Marker Definitions ===

This BIP defines three marker bytes for witness version 2 keypath spends:

* <code>0xbb</code>: '''Opt-out marker''' - Input does not participate in aggregation and uses a standard BIP340 signature
* <code>0xbc</code>: '''Half-aggregation marker''' - Input participates in half-aggregation
* <code>0xbd</code>: '''Full-aggregation marker''' - Input participates in full-aggregation

These byte values were chosen from the undefined range (0xbb-0xfe) to avoid
semantic confusion with existing opcodes.

=== Transaction Structure ===

Transactions using signature aggregation follow the standard Bitcoin transaction
format with a modified witness structure. A transaction may contain at most two
aggregation groups: one half-aggregation group and one full-aggregation group.
Aggregated and non-aggregated inputs can be mixed in any order, with the
constraint that all markers for a group must appear before that group's
aggregate signature.

=== Witness Element Structure ===

Each witness v2 keypath spend uses a single witness element (plus optional
annex) containing the marker, optional sighash, and optional signature
concatenated together:

* '''Marker''': First byte (0xbb, 0xbc, or 0xbd)
* '''Sighash type''': Optional second byte; if absent, SIGHASH_DEFAULT (0x00) is used
* '''Signature''': For opted-out inputs or the final input of an aggregation group

The length of the witness element determines its interpretation:

{| class="wikitable"
|+ Witness element structure by length
|-
! Length !! Structure !! Interpretation
|-
| 1 byte || [marker] || Aggregation placeholder, SIGHASH_DEFAULT
|-
| 2 bytes || [marker || sighash] || Aggregation placeholder, explicit sighash
|-
| 65 bytes || [marker || 64-byte sig] || Opted-out or aggregation final, SIGHASH_DEFAULT
|-
| 66 bytes || [marker || sighash || 64-byte sig] || Opted-out or aggregation final, explicit sighash
|-
| (n+1)*32+1 bytes || [marker || half-agg sig] || Half-aggregation final, SIGHASH_DEFAULT
|-
| (n+1)*32+2 bytes || [marker || sighash || half-agg sig] || Half-aggregation final, explicit sighash
|}

=== Sighash Handling ===

Unlike BIP341 where sighash can be appended to the signature (resulting in
65-byte signatures), witness v2 adds the sighash type after the marker:

* '''1-byte marker''': Input uses SIGHASH_DEFAULT (0x00)
* '''2-byte marker''': Second byte specifies the sighash type

All signatures in witness v2 must be either 64 bytes or (n+1)*32 bytes for
half-aggregation. This provides consistent sighash handling across all input
types (opted-out, half-agg, and full-agg).

Valid sighash types are:

* <code>0x00</code>: SIGHASH_DEFAULT
* <code>0x01</code>: SIGHASH_ALL
* <code>0x02</code>: SIGHASH_NONE
* <code>0x03</code>: SIGHASH_SINGLE
* <code>0x81</code>: SIGHASH_ALL | SIGHASH_ANYONECANPAY
* <code>0x82</code>: SIGHASH_NONE | SIGHASH_ANYONECANPAY
* <code>0x83</code>: SIGHASH_SINGLE | SIGHASH_ANYONECANPAY

Note: While all sighash types are syntactically valid, SIGHASH_ANYONECANPAY has
important compatibility considerations with signature aggregation. See the
Rationale section for details.

=== Annex Handling ===

Following BIP341, if there are at least two witness elements and the first byte
of the last element is <code>0x50</code>, the last element is the annex. The
annex is removed before parsing the main witness element.

=== Opted-Out Witness v2 Keypath Spend ===

An opted-out witness v2 keypath spend has a witness stack containing:

* '''Without annex''': <code>[0xbb || signature]</code> (65 bytes) or <code>[0xbb || sighash || signature]</code> (66 bytes)
* '''With annex''': <code>[0xbb || signature] [0x50...]</code> or <code>[0xbb || sighash || signature] [0x50...]</code>

The opt-out marker explicitly indicates that this input must not be aggregated.
Validation proceeds using standard BIP340 signature verification against the
output key.

=== Aggregated Witness v2 Keypath Spend ===

For inputs participating in aggregation, all inputs contain at least a marker. The last
aggregated input additionally contains the aggregate signature concatenated
with the marker.

'''All aggregated inputs except the last:'''

* '''Without annex''': <code>[marker]</code> (1 byte) or <code>[marker || sighash]</code> (2 bytes)
* '''With annex''': <code>[marker] [0x50...]</code> or <code>[marker || sighash] [0x50...]</code>

Where marker is <code>0xbc</code> (half-agg) or <code>0xbd</code> (full-agg).

'''Last aggregated input:'''

* '''Without annex''': <code>[marker || signature]</code> or <code>[marker || sighash || signature]</code>
* '''With annex''': <code>[marker || signature] [0x50...]</code> or <code>[marker || sighash || signature] [0x50...]</code>

=== Examples ===

'''Example 1: Three inputs, all half-aggregated with SIGHASH_DEFAULT'''
<source>
Input 0 witness: [0xbc]                     # 1 byte: half-agg placeholder
Input 1 witness: [0xbc]                     # 1 byte: half-agg placeholder
Input 2 witness: [0xbc || 128-byte sig]     # 129 bytes: half-agg final (n=3)

Total overhead: 3 marker bytes
Signature size reduction: 192 bytes → 128 bytes
</source>

'''Example 2: Three inputs full-aggregated with SIGHASH_ALL'''
<source>
Input 0 witness: [0xbd || 0x01]                 # 2 bytes: full-agg placeholder, SIGHASH_ALL
Input 1 witness: [0xbd || 0x01]                 # 2 bytes: full-agg placeholder, SIGHASH_ALL
Input 2 witness: [0xbd || 0x01 || 64-byte sig]  # 66 bytes: full-agg final (n=3), SIGHASH_ALL

Total overhead: 3 marker bytes
Signature size reduction: 192 bytes → 64 bytes
</source>

'''Example 3: Mixed half-agg and full-agg groups'''
<source>
Input 0 witness: [0xbc]                     # 1 byte: Half-agg placeholder
Input 1 witness: [0xbd]                     # 1 byte: Full-agg placeholder
Input 2 witness: [0xbc || 96-byte sig]      # 97 bytes: Half-agg final (n=2)
Input 3 witness: [0xbd || 64-byte sig]      # 65 bytes: Full-agg final (n=2)

Two aggregation groups:
- Inputs 0, 2: half-aggregation (96 bytes)
- Inputs 1, 3: full-aggregation (64 bytes)

Total overhead: 4 marker bytes
Signature size reduction: 256 bytes → 160 bytes
</source>

'''Example 4: Opted-out input with explicit sighash (adaptor signature protection)'''
<source>
Input 0 witness: [0xbb || 0x01 || 64-byte sig]  # 66 bytes: opted-out, SIGHASH_ALL
Input 1 witness: [0xbd]                         # 1 byte: Full-agg placeholder
Input 2 witness: [0xbd || 64-byte sig]          # 65 bytes: Full-agg final (n=2)

Input 0 uses an adaptor signature with SIGHASH_ALL and is protected.
Inputs 1, 2 are full-aggregated normally.

Total overhead: 3 marker bytes
Signature size reduction: 192 bytes → 128 bytes
</source>

'''Example 5: Complex mixed transaction'''
<source>
Input 0 witness: [0xbb || 64-byte sig]          # 65 bytes: opted-out, DEFAULT
Input 1 witness: [0xbc || 0x03]                 # 2 bytes: half-agg, SIGHASH_SINGLE
Input 2 witness: [0xbd]                         # 1 byte: full-agg placeholder
Input 3 witness: [0xbd]                         # 1 byte: full-agg placeholder
Input 4 witness: [0xbc || 96-byte sig]          # 97 bytes: half-agg final (n=2)
Input 5 witness: [0xbb || 0x82 || 64-byte sig]  # 66 bytes: opted-out, SIGHASH_NONE|ANYONECANPAY
Input 6 witness: [0xbd || 64-byte sig]          # 65 bytes: full-agg final (n=3)

This transaction has:
- Two opted-out inputs (0, 5) with different sighash types
- One half-aggregation group (inputs 1, 4)
- One full-aggregation group (inputs 2, 3, 6)

Total overhead: 7 marker bytes
Signature size reduction: 448 bytes → 288 bytes
</source>

=== Validation Rules ===

A witness v2 keypath spend is validated using a three-pass approach:

'''Pass 1: Parse and collect aggregation information'''

For each input with witness v2:

1. '''Extract annex if present''':
   * If the witness stack has at least two elements, and the first byte of the last element is <code>0x50</code>, this last element is the annex and is removed from the witness stack

2. '''Parse the witness element''':
   * First byte determines marker type (0xbb, 0xbc, or 0xbd)
   * Length determines structure per the table above
   * Extract sighash_type and signature if present
   * Verify sighash_type is valid (0x00-0x03, 0x81-0x83)

3. '''Classify input''':
   * '''0xbb with signature''': Opted-out input
   * '''0xbc/0xbd without signature''': Aggregation placeholder
   * '''0xbc/0xbd with signature''': Aggregation final

'''Pass 2: Validate aggregation group structure'''

1. '''Group formation rules''':
   * At most one half-aggregation group (marker 0xbc)
   * At most one full-aggregation group (marker 0xbd)
   * Each group must have exactly one final input (with signature)
   * Fail if a group's marker reappears after that group's final input
   * Opted-out inputs (marker 0xbb) do not form groups

2. '''For each aggregation group''':
   * Count n = number of inputs in the group
   * Verify aggregate signature size:
     * Half-agg: must equal (n+1) * 32 bytes
     * Full-agg: must equal 64 bytes

3. '''Explicit failure conditions''':
   * Aggregation markers without corresponding final input: Fail
   * Multiple final inputs for same marker type: Fail
   * Marker appearing after its group's final input: Fail
   * Invalid signature size for aggregation type: Fail

'''Pass 3: Verify signatures'''

1. '''For each opted-out input''':
   * Compute message = SigMsg(sighash_type, 0)
   * Verify using BIP340 against output key

2. '''For each aggregation group''':
   * Collect all inputs with matching markers that appeared before the final input
   * For each aggregated input i: compute m_i = SigMsg(sighash_types[i], 0)
   * For half-agg: Use BIP-Halfagg verification
   * For full-agg: Use BIP-Fullagg verification
   * Fail if verification fails

== Rationale ==

=== Why a New Witness Version? ===

A new witness version (v2) is necessary because BIP141 requires that each
witness version have completely specified validation rules. Reusing witness
v1 would create ambiguity about whether inputs use Taproot or aggregation
semantics.

=== Why the Marker-Based Design? ===

The marker-based approach was chosen after considering two primary alternatives:
A less flexible but more space efficient alternative would be to allow only one
aggregation group per transaction and disallowing opt-out. This would result in
saving the marker bytes but result in much reduced flexibility. A more flexible
approach would be to allow for multiple full aggregation buckets within one transaction.

The current marker-based approach was chosen since it appears to strike a good
balance between efficiency and flexibility and early feedback indicated that the
flexibility would be interesting for users, particularly the opt-out option.

=== Why Explicit Opt-Out? ===

The opt-out marker (0xbb) protects inputs from non-consensual aggregation.
Half-aggregation is non-interactive and can be performed by any third party
(such as miners). Without explicit opt-out, adaptor signatures and similar
protocols would be vulnerable to having their cryptographic properties destroyed
by aggregation. The opt-out marker disallows this and also leaves the door
open to aggregate signatures that were not marked as opt-out explicitly to
be aggregated by a potential future block-wide half-aggregation.

=== Why Two Aggregation Schemes? ===

Half-aggregation and full-aggregation serve different use cases:

{| class="wikitable"
|+ Comparison of aggregation schemes
|-
! Property !! Half-Aggregation !! Full-Aggregation
|-
| '''Signature Size''' || (n+1)*32 bytes || 64 bytes (constant)
|-
| '''Interactivity''' || Non-interactive || Interactive (2 rounds)
|-
| '''Use Case''' || All transaction types, Lightning gossip || Interactive protocols such as CoinJoins, wallet consolidation
|-
| '''Incremental''' || Yes || No
|-
| '''Adaptor Compatibility''' || Incompatible || Potentially compatible with some protocols
|}

Supporting both schemes allows applications to choose the optimal tradeoff:
* '''Half-aggregation''' is ideal for scenarios where signers cannot coordinate
* '''Full-aggregation''' is ideal for scenarios where signers are coordinating

=== Why Keypath Only? ===

This proposal limits aggregation to keypath spends for the following reasons:

'''Reduced complexity''': Script path spends involve arbitrary scripts with potentially multiple signatures and complex validation logic. Determining which signatures to aggregate requires script analysis and creates many edge cases.

'''Sufficient for primary use cases''': The majority of expected Taproot usage is keypath spends. Multi-input transactions that would benefit most from aggregation typically use simple keypath spends.

'''Clear semantics''': Keypath spends have unambiguous validation semantics - one signature per input. Script path aggregation would require determining:
* Which OP_CHECKSIG operations should be aggregated
* How OP_CHECKSIGADD interacts with aggregation  
* Whether MuSig-style key aggregation can be combined with signature aggregation

'''Still allows future expansion''': Limiting this BIP to keypath spends doesn't prevent future BIPs from adding script path aggregation after the design is thoroughly vetted.

Script path aggregation is an important future direction but should be addressed in a separate proposal after keypath aggregation has been deployed and evaluated.

=== Comment on usage of ANYONECANPAY ===

This BIP permits all standard sighash types at the consensus level, including
SIGHASH_ANYONECANPAY (0x80 flag), even though ANYONECANPAY has important
compatibility considerations with signature aggregation.

'''Rationale for allowing ANYONECANPAY''': The decision of when to aggregate signatures is a protocol/application layer concern, not a consensus concern. Consensus rules should be permissive and allow all valid sighash types. Applications can choose whether to use aggregation based on their specific requirements.

'''Full-Aggregation Incompatibility''': Full-aggregation is genuinely incompatible with the typical use-case of ANYONECANPAY because full-aggregation requires interactive signing with all participants coordinating during the signature creation process. If one party uses ANYONECANPAY with the intent of allowing inputs to be added later, the interactive protocol cannot be completed until all inputs are known, defeating the purpose of ANYONECANPAY.

'''Half-Aggregation Compatibility''': Half-aggregation can work with ANYONECANPAY inputs through a specific workflow:

# Transaction is constructed with ANYONECANPAY inputs
# Additional inputs are added as needed (the purpose of ANYONECANPAY)
# Once the input set is finalized, half-aggregation is performed on all inputs

Since half-aggregation is '''non-interactive''' and can be performed '''after'''
all inputs are finalized, the aggregation coefficients depend on the complete
set of R values, but once that set is fixed, anyone can perform the aggregation
without coordination with the original signers.

=== Future Considerations ===

'''Block-wide Aggregation''': This proposal focuses on transaction-wide
aggregation. Block-wide aggregation remains a potential future optimization.
The design of this BIP does not preclude block-wide aggregation.

'''Script path Aggregation''': Script path aggregation can be specified in
a separate BIP and added in the same or a future soft fork.

'''Computation Limits''': Signature verification has a relatively high
computational cost per byte of witness data. While existing consensus limits
provide protection, implementers should be aware of verification costs when
processing transactions with many aggregated inputs.

'''Quantum Resistance''': Like all elliptic curve cryptography, aggregated
Schnorr signatures are vulnerable to quantum attacks via Shor's algorithm.
This proposal does not address quantum resistance, which should be handled
separately.

== Test Vectors ==

TODO: Test Vectors

== Reference Implementation ==

TODO: Bitcoin Core PR

== Backward Compatibility ==

=== Non-Upgraded Nodes ===

Nodes that have not upgraded to support witness version 2 will:

* '''Validation''': Treat witness v2 outputs as anyone-can-spend (per BIP141 unknown witness version rule)
* '''Relay''': May not relay witness v2 transactions (policy dependent)
* '''Mining''': May not include witness v2 transactions in blocks (policy dependent)

This is standard soft fork behavior. Non-upgraded nodes remain compatible with
the network but don't enforce the new rules.

=== Non-Upgraded Wallets ===

Wallets that have not been updated to support witness v2:

* '''Cannot create witness v2 addresses'''
* '''Cannot spend witness v2 outputs''' (will not recognize them)
* '''Can send to witness v2 addresses''' (if they support Bech32m encoding)
* '''Can use witness v0 (Segwit) and v1 (Taproot) normally'''

Users of non-upgraded wallets are not negatively affected but cannot benefit
from aggregation until they upgrade.

=== Taproot Compatibility ===

Witness v2 is designed to coexist with witness v1 (Taproot):

* The same keys can be used for both (with appropriate tweaking)
* Transactions can mix witness v1 and v2 inputs
* The same HD derivation paths can be used
* Migration from v1 to v2 is straightforward

== Acknowledgments ==

This proposal builds on extensive research and community discussions:

* '''BIP340, 341, 342 authors''': Pieter Wuille, Jonas Nick, Tim Ruffing, and Anthony Towns for the Taproot foundation this builds upon
* '''Half-aggregation research''': Jonas Nick and Tim Ruffing for their work on half-aggregation of BIP340 signatures
* '''DahLIAS research''': Jonas Nick, Tim Ruffing, and Yannick Seurin for the full-aggregation protocol
* '''CISA research community''': Contributors to cisaresearch.org and ongoing discussions
* '''Security proofs''': Konstantinos Chalkias, Francois Garillot, Yashvanth Kondi, Valeria Nikolaenko (CT-RSA 2021), and Yanbo Chen, Yunlei Zhao (IACR 2022) for half-aggregation security proofs
* '''Bitcoin Core developers''': For discussions at CoreDev meetings about implementation challenges and tradeoffs

Thanks to the broader Bitcoin community for feedback on early drafts and ideas.

== References ==

# [https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki BIP340: Schnorr Signatures for secp256k1]
# [https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki BIP341: Taproot: SegWit version 1 spending rules]
# [https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki BIP342: Validation of Taproot Scripts]
# [https://github.com/BlockstreamResearch/cross-input-aggregation/blob/master/half-aggregation.mediawiki Half-Aggregation of BIP 340 Signatures] (Draft BIP)
# [https://eprint.iacr.org/2025/692 DahLIAS: Discrete Logarithm-Based Interactive Aggregate Signatures] Nick, Ruffing, Seurin (2025)
# [https://eprint.iacr.org/2022/222 Half-Aggregation of Schnorr Signatures with Tight Reductions] Chen & Zhao (2022)
# [https://eprint.iacr.org/2021/350 Non-Interactive Half-Aggregation of EdDSA and Variants of Schnorr Signatures] Chalkias et al. (2021)
# [https://cisaresearch.org/ CISA Research Website]
# [https://hrf.org/latest/cisa-research-paper/ HRF CISA Research Paper]

== Footnotes ==

<references />

== Changelog ==

* 2025-09-15: Initial draft
* 2025-02-07: Addressed feedback from CoreDev meeting: added opt-out marker for adaptor signature protection; changed marker values to 0xbb/0xbc/0xbd
